<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>足付エルボ 計算ツール</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
    --ios-bg: #000000;
    --ios-card: #1c1c1e;
    --ios-input: #2c2c2e;
    --ios-input-border: #3a3a3c;
    --ios-secondary-text: #aeaeb2;
    --ios-placeholder: #636366;
    --ios-orange: #ff9f0a;
    --ios-orange-dark: #995c00;
    --ios-orange-light: #ffaa33;
    
    --accent-90: #5e5ce6;
    --accent-45: #30d158;
}

* {
    box-sizing: border-box;
    -webkit-text-size-adjust: 100%;
}

body {
    margin: 0;
    background: var(--ios-bg);
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 6px;
    color: #ffffff;
    touch-action: pan-y;
    min-height: 100vh;
}

/* タブメニューのスリム化 */
.tab-wrapper {
    position: sticky;
    top: 0;
    z-index: 100;
    width: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    padding: 8px 0;
    display: flex;
    justify-content: center;
}

.tab-container {
    display: flex;
    background: var(--ios-card);
    padding: 3px;
    border-radius: 16px;
    width: 100%;
    max-width: 420px;
    border: 1px solid var(--ios-border);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.tab-btn {
    flex: 1;
    padding: 6px 4px;
    border: none;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    background: transparent;
    color: #8e8e93;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
}

@media (min-width: 380px) {
    .tab-btn { font-size: 14px; padding: 8px 4px; }
}

.tab-btn.active {
    background: linear-gradient(180deg, #636366 0%, #48484a 100%);
    color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
}

.card {
    width: 100%;
    max-width: 420px;
    background: var(--ios-card);
    border-radius: 24px;
    padding: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    position: relative;
    user-select: none;
    margin-top: 10px;
    margin-bottom: 40px;
}

.header { text-align: center; margin-bottom: 20px; }
.title { font-size: 24px; font-weight: 700; margin: 0; }
.subtitle { font-size: 14px; color: #8e8e93; letter-spacing: 0.15em; font-weight: 600; margin-top: 4px; }

.result-display-box {
    transition: background 0.3s ease, box-shadow 0.3s ease;
    height: 104px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 16px;
    border-radius: 20px;
    cursor: pointer;
}

.mode-90 .result-display-box { background: var(--accent-90); box-shadow: 0 10px 20px rgba(94, 92, 230, 0.4); }
.mode-45 .result-display-box { background: var(--accent-45); box-shadow: 0 10px 20px rgba(48, 209, 88, 0.4); }

.label-inside { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.result-value-text { font-size: 40px; font-weight: 900; display: flex; align-items: baseline; gap: 4px; }
.result-unit-text { font-size: 18px; font-weight: 700; opacity: 0.9; }

.input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
.size-row { display: flex; gap: 12px; }
.input-container { display: flex; flex-direction: column; gap: 6px; flex: 1; }

.label-outside { 
    font-size: 15px; 
    font-weight: 700; 
    color: #d1d1d6; 
    margin-left: 8px; 
}

.input-box {
    width: 100%;
    background: var(--ios-input);
    border-radius: 14px;
    border: 1.5px solid #444446;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s ease;
}

.input-box.medium { height: 60px; border-radius: 16px; }
.input-box.large { height: 75px; border-radius: 22px; background: #121214; }
.static-box { background: #121214; border: 1.5px solid #48484a; }

.mode-90 .input-themed { border-width: 2.5px; border-color: var(--accent-90); }
.mode-45 .input-themed { border-width: 2.5px; border-color: var(--accent-45); }

.select, .input {
    width: 100%; background: transparent; border: none; color: #ffffff; text-align: center; outline: none;
}
.select { 
    font-size: 23px;
    font-weight: 800; 
    -webkit-appearance: none; 
    cursor: pointer; 
}

.input { font-size: 32px; font-weight: 900; }
.input.small-font { font-size: 24px; font-weight: 800; }

/* プレースホルダーをラベルと同じサイズに設定 */
.input::placeholder {
    font-size: 15px;
    font-weight: 700;
    color: var(--ios-placeholder);
}

.static-value { width: 100%; color: #aeaeb2; display: flex; justify-content: center; align-items: baseline; gap: 2px; font-size: 21px; font-weight: 800; }
.static-unit { font-size: 14px; font-weight: 600; }

/* 履歴セクション */
.history-section { border-top: 1px solid #38383a; padding-top: 16px; }
.history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.history-title { font-size: 14px; font-weight: 700; color: #8e8e93; }
.history-clear-all { font-size: 14px; color: #ff453a; cursor: pointer; background: none; border: none; font-weight: 700; }

.history-list { display: flex; flex-direction: column; gap: 8px; }

.history-item {
    background: var(--ios-input); 
    border-radius: 14px; 
    padding: 10px 12px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border: 1.5px solid #3a3c3e;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.history-item.is-locked {
    border: 2px solid var(--ios-orange);
    background: #2c2c2e;
    box-shadow: 0 0 12px rgba(255, 159, 10, 0.3);
}

.lock-btn {
    padding: 8px;
    border-radius: 10px;
    background: #3a3a3c;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.lock-btn.active {
    background: var(--ios-orange);
    color: white;
}

.history-info { display: flex; flex-direction: column; }
.history-tags { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.history-size-tag { 
    background: rgba(255, 255, 255, 0.1); 
    padding: 1px 6px; 
    border-radius: 6px; 
    font-weight: 700; 
    border: 1px solid #444; 
    font-size: 13px;
}

.history-result { font-size: 20px; font-weight: 900; line-height: 1; }
.history-delete { color: #ff453a; cursor: pointer; font-size: 28px; font-weight: bold; margin-left: 10px; padding: 0px 8px; line-height: 1; opacity: 0.5; }

/* モーダル */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    display: none; justify-content: center; align-items: center;
    z-index: 2000;
}
.modal-content {
    background: #2c2c2e; width: 85%; max-width: 270px; border-radius: 14px; text-align: center;
    overflow: hidden; border: 1px solid #444446;
}
.modal-btn { flex: 1; padding: 12px; font-size: 17px; border: none; background: transparent; cursor: pointer; }

#statusToast {
    position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: var(--accent-90); color: white; padding: 10px 24px; border-radius: 50px; font-weight: bold;
    transition: all 0.3s; opacity: 0; pointer-events: none; z-index: 3000;
}
#statusToast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.footer { text-align: center; margin-top: 24px; font-size: 12px; color: #8e8e93; letter-spacing: 0.05em; font-weight: 600; }
.hidden { display: none !important; }
</style>
</head>

<body class="mode-90">

<div id="statusToast">コピーしました</div>

<!-- 削除確認モーダル -->
<div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <div style="padding: 20px 16px;">
            <div class="text-white font-semibold mb-1 text-lg">履歴のクリア</div>
            <div id="modal-msg" class="text-gray-400 text-sm">保護されていない履歴を全て削除しますか？</div>
        </div>
        <div style="display: flex; border-top: 0.5px solid #3a3a3c;">
            <button class="modal-btn" id="modal-cancel" style="color: #0a84ff; border-right: 0.5px solid #3a3a3c;">キャンセル</button>
            <button class="modal-btn" id="modal-confirm" style="color: #ff453a; font-weight: 600;">削除する</button>
        </div>
    </div>
</div>

<div class="tab-wrapper">
    <div class="tab-container">
        <button class="tab-btn active" data-mode="90">足付 90°エルボ</button>
        <button class="tab-btn" data-mode="45">足付 45°エルボ</button>
    </div>
</div>

<div class="card" id="main-card">
    <div class="header">
        <div class="title" id="page-title">足付 90°エルボ</div>
        <div class="subtitle">KYOWA ROOF</div>

        <div class="result-display-box" onclick="copyResult()">
            <div class="label-inside" id="result-label" style="color: #bfbdf3;">切断寸法</div>
            <div class="result-value-text">
                <span id="result">---</span>
                <span class="result-unit-text">mm</span>
            </div>
        </div>
    </div>

    <div class="input-group">
        <div class="size-row">
            <div class="input-container">
                <div class="label-outside">サイズ</div>
                <div class="input-box medium input-themed" id="input-box-size">
                    <select id="size" class="select">
                        <option value="75">75</option>
                        <option value="100" selected>100</option>
                        <option value="125">125</option>
                    </select>
                </div>
            </div>
            <div class="input-container">
                <div class="label-outside">足寸法</div>
                <div class="input-box medium input-themed">
                    <input id="leg-input" class="input small-font" type="text" inputmode="decimal" placeholder="必須">
                </div>
            </div>
        </div>

        <div class="size-row">
            <div class="input-container" style="flex: 0.75;">
                <div class="label-outside">重寸法</div>
                <div class="input-box large static-box">
                    <div class="static-value">
                        <span id="d">--</span><span class="static-unit">mm</span>
                    </div>
                </div>
            </div>

            <div class="input-container" style="flex: 2.25;">
                <div class="label-outside">芯〜芯 寸法</div>
                <div class="input-box large input-themed">
                    <input id="input" class="input" type="text" inputmode="decimal" placeholder="必須">
                </div>
            </div>
        </div>
    </div>

    <div class="history-section">
        <div class="history-header">
            <span class="history-title">履歴 (オレンジは保護中)</span>
            <button id="history-clear-all" class="history-clear-all">クリア</button>
        </div>
        <div id="history-list" class="history-list"></div>
    </div>

    <div class="footer">入力後に自動保存されます(3件まで)</div>
</div>

<script>
const elbowData = {
    "90": { 75: { d: 30, e: 88 }, 100: { d: 40, e: 112 }, 125: { d: 50, e: 140 } },
    "45": { 75: { d: 30, e: 65 }, 100: { d: 40, e: 80 }, 125: { d: 50, e: 103 } }
};

const sizeConstants = { "75": 45, "100": 57, "125": 70 };
const storageKey = 'kyowa_elbow_dark_v6';
const stateKey = 'kyowa_elbow_state_v6';
const tabList = ["90", "45"];

let currentMode = "90";
let histories = JSON.parse(localStorage.getItem(storageKey)) || [];
let tabStates = JSON.parse(localStorage.getItem(stateKey)) || {
    "90": { input: "", legInput: "", size: "100" },
    "45": { input: "", legInput: "", size: "100" }
};

const elements = {
    body: document.body,
    tabBtns: document.querySelectorAll(".tab-btn"),
    pageTitle: document.getElementById("page-title"),
    resultLabel: document.getElementById("result-label"),
    sizeEl: document.getElementById("size"),
    inputEl: document.getElementById("input"),
    legInputEl: document.getElementById("leg-input"),
    dEl: document.getElementById("d"),
    resultEl: document.getElementById("result"),
    historyListEl: document.getElementById("history-list"),
    modal: document.getElementById("modal-overlay")
};

function formatNum(num) {
    if (num === null || isNaN(num)) return "---";
    const parts = num.toString().split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
}
function unformat(str) { return str.replace(/,/g, ""); }

function showToast(msg) {
    const t = document.getElementById('statusToast');
    t.innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

function copyResult() {
    const val = elements.resultEl.innerText;
    if (val === "---") return;
    const temp = document.createElement('textarea');
    temp.value = unformat(val);
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    showToast("コピーしました");
}

function switchTab(mode) {
    if (mode === currentMode) return;
    
    tabStates[currentMode] = {
        input: elements.inputEl.value,
        legInput: elements.legInputEl.value,
        size: elements.sizeEl.value
    };
    localStorage.setItem(stateKey, JSON.stringify(tabStates));

    currentMode = mode;
    elements.tabBtns.forEach(b => b.classList.toggle("active", b.dataset.mode === mode));
    elements.body.className = `mode-${mode}`;
    elements.pageTitle.textContent = `足付 ${mode}°エルボ`;
    elements.resultLabel.style.color = mode === "90" ? "#bfbdf3" : "#ffffff";
    
    const state = tabStates[mode];
    elements.inputEl.value = state.input;
    elements.legInputEl.value = state.legInput;
    elements.sizeEl.value = state.size;
    
    calc();
    renderHistory();
}

// スワイプ機能
let touchStartX = 0;
let touchStartY = 0;
window.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].clientX;
    touchStartY = e.changedTouches[0].clientY;
}, { passive: true });

window.addEventListener('touchend', (e) => {
    const diffX = e.changedTouches[0].clientX - touchStartX;
    const diffY = Math.abs(e.changedTouches[0].clientY - touchStartY);
    if (['INPUT', 'SELECT'].includes(document.activeElement.tagName)) return;
    if (diffY > 40 || Math.abs(diffX) < 60) return;
    const idx = tabList.indexOf(currentMode);
    if (diffX < 0 && idx < tabList.length - 1) switchTab(tabList[idx + 1]);
    else if (diffX > 0 && idx > 0) switchTab(tabList[idx - 1]);
}, { passive: true });

function calc() {
    const size = elements.sizeEl.value;
    const constVal = sizeConstants[size];
    let valStr = elements.inputEl.value;
    let rawInput = unformat(valStr).replace(/[^\d.]/g, "");
    if (rawInput !== "") {
        const parts = rawInput.split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        elements.inputEl.value = parts.join(".");
    }

    const { d, e } = elbowData[currentMode][size];
    elements.dEl.textContent = d;

    const inputVal = parseFloat(rawInput);
    const legVal = parseFloat(unformat(elements.legInputEl.value));
    
    tabStates[currentMode] = { input: elements.inputEl.value, legInput: elements.legInputEl.value, size: size };
    localStorage.setItem(stateKey, JSON.stringify(tabStates));

    if (isNaN(inputVal) || isNaN(legVal)) {
        elements.resultEl.textContent = "---";
        return;
    }

    const c = inputVal - (legVal + constVal);
    let f;
    if (currentMode === "90") {
        f = c - ((e * 2) - (d * 2));
        elements.resultEl.textContent = formatNum(Math.round(f * 10) / 10);
    } else {
        const cos45 = Math.cos(45 * Math.PI / 180);
        f = (c / cos45) - ((e - d) * 2);
        elements.resultEl.textContent = formatNum(Math.ceil(f));
    }
}

function saveHistory() {
    const result = elements.resultEl.textContent;
    if (result === "---") return;
    
    const input = elements.inputEl.value;
    const leg = elements.legInputEl.value;
    const size = elements.sizeEl.value;

    const last = histories[histories.length - 1];
    if (last && last.mode === currentMode && last.input === input && last.leg === leg && last.size === size) return;

    // 自動保存枠の制限（ロックなしを削除対象）
    const unlocked = histories.filter(h => h.mode === currentMode && !h.locked);
    if (unlocked.length >= 3) {
        const oldestIdx = histories.findIndex(h => h.mode === currentMode && !h.locked);
        if (oldestIdx !== -1) histories.splice(oldestIdx, 1);
    }

    histories.push({
        id: Date.now(),
        mode: currentMode,
        size, input, leg, result,
        locked: false
    });
    localStorage.setItem(storageKey, JSON.stringify(histories));
    renderHistory();
}

function renderHistory() {
    const list = elements.historyListEl;
    list.innerHTML = "";
    const filtered = histories.filter(h => h.mode === currentMode).sort((a, b) => {
        if (a.locked !== b.locked) return b.locked ? 1 : -1;
        return b.id - a.id;
    });

    if (!filtered.length) {
        list.innerHTML = '<div style="text-align:center; padding:15px; color:#48484a; font-size:12px; font-weight:bold;">履歴はありません</div>';
        return;
    }

    filtered.forEach(h => {
        const div = document.createElement("div");
        div.className = `history-item ${h.locked ? 'is-locked' : ''}`;
        const lockIcon = h.locked ? 
            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>' :
            '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';

        div.innerHTML = `
            <div class="flex items-center gap-3">
                <button onclick="toggleLock(${h.id})" class="lock-btn ${h.locked ? 'active' : 'text-zinc-500'}">${lockIcon}</button>
                <div class="history-info">
                    <div class="history-tags">
                        <span class="history-size-tag">${h.size}</span>
                        <span class="text-[13px] text-[#c0c0c0]">足:${h.leg} 芯:${h.input}</span>
                    </div>
                    <span class="history-result">${h.result}</span>
                </div>
            </div>
            <div>
                ${!h.locked ? `<span class="history-delete" onclick="deleteHistory(${h.id})">×</span>` : '<span class="text-orange-500 font-black text-[10px] pr-2">FIXED</span>'}
            </div>`;
        list.appendChild(div);
    });
}

function toggleLock(id) {
    const item = histories.find(h => h.id === id);
    if (item) {
        item.locked = !item.locked;
        localStorage.setItem(storageKey, JSON.stringify(histories));
        renderHistory();
    }
}

function deleteHistory(id) {
    histories = histories.filter(h => h.id !== id);
    localStorage.setItem(storageKey, JSON.stringify(histories));
    renderHistory();
}

document.getElementById('history-clear-all').onclick = () => elements.modal.style.display = "flex";
document.getElementById('modal-cancel').onclick = () => elements.modal.style.display = "none";
document.getElementById('modal-confirm').onclick = () => {
    histories = histories.filter(h => h.mode !== currentMode || h.locked);
    localStorage.setItem(storageKey, JSON.stringify(histories));
    renderHistory();
    elements.modal.style.display = "none";
};

elements.tabBtns.forEach(btn => btn.onclick = () => switchTab(btn.dataset.mode));
[elements.inputEl, elements.legInputEl].forEach(el => {
    el.oninput = calc;
    el.addEventListener('focus', function() { setTimeout(() => this.setSelectionRange(0, 9999), 50); });
    el.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); saveHistory(); el.blur(); } });
    el.addEventListener('blur', () => { if (el.value) saveHistory(); });
});
elements.sizeEl.onchange = () => { calc(); saveHistory(); };

window.onload = () => {
    const state = tabStates[currentMode];
    elements.inputEl.value = state.input;
    elements.legInputEl.value = state.legInput;
    elements.sizeEl.value = state.size;
    calc();
    renderHistory();
};
</script>

</body>
</html>